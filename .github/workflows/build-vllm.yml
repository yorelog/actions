name: Build vLLM Docker Image Based on Cuda 12.4

on:
  workflow_dispatch:
    inputs:
      vllm_version:
        description: 'vLLMç‰ˆæœ¬ (ä¾‹å¦‚: releases/v0.10.2)'
        required: true
        type: string
        default: 'releases/v0.10.2'
      cuda_version:
        description: 'CUDAç‰ˆæœ¬'
        required: false
        type: string
        default: '12.4.1'
      python_version:
        description: 'Pythonç‰ˆæœ¬'
        required: false
        type: string
        default: '3.12'
      torch_cuda_arch_list:
        description: 'Torch CUDAæ¶æ„åˆ—è¡¨'
        required: false
        type: string
        default: '8.0 8.6 8.9'
      target_namespace:
        description: 'ç›®æ ‡å‘½åç©ºé—´'
        required: false
        default: 'yoce'
        type: string

env:
  ALIYUN_REGISTRY: registry.cn-beijing.aliyuncs.com
  DOCKER_BUILDKIT: 1

jobs:
  build-vllm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Quick cleanup of large components
      run: |
        echo "ğŸš€ å¿«é€Ÿæ¸…ç†å·²çŸ¥å¤§å‹ç»„ä»¶..."
        
        echo "æ¸…ç†å‰æ ¹åˆ†åŒºç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
        
        # åŸºäºç»éªŒå¿«é€Ÿæ¸…ç†æœ€å¤§çš„ç»„ä»¶
        echo "ğŸ—‘ï¸ åˆ é™¤Swiftå·¥å…·é“¾ (~2.8G)..."
        sudo rm -rf /usr/share/swift || true
        
        echo "ğŸ—‘ï¸ åˆ é™¤Miniconda (~748M)..."
        sudo rm -rf /usr/share/miniconda || true
        
        echo "ğŸ—‘ï¸ åˆ é™¤Azure CLI (~496M)..."
        sudo rm -rf /usr/share/az_* || true
        
        echo "ğŸ—‘ï¸ åˆ é™¤Gradle (~143M)..."
        sudo rm -rf /usr/share/gradle-* || true
        
        echo "ğŸ—‘ï¸ åˆ é™¤å…¶ä»–å¤§å‹ç»„ä»¶..."
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf /usr/local/share/powershell || true
        sudo rm -rf /opt/hostedtoolcache/CodeQL || true
        sudo rm -rf /usr/local/lib/android || true
        
        echo "å¿«é€Ÿæ¸…ç†åæ ¹åˆ†åŒºç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
        echo "âœ… å¿«é€Ÿæ¸…ç†å®Œæˆï¼Œé¢„è®¡é‡Šæ”¾çº¦4-5GBç©ºé—´"
        
    - name: Analyze disk usage and mounts
      run: |
        echo "ğŸ“Š æ¸…ç†åç£ç›˜ç¯å¢ƒåˆ†æ..."
        
        echo "=== ç£ç›˜æŒ‚è½½ä¿¡æ¯ ==="
        df -h
        echo ""
        
        echo "=== å—è®¾å¤‡ä¿¡æ¯ ==="
        lsblk
        echo ""
        
        echo "=== /mntç›®å½•å†…å®¹ ==="
        ls -la /mnt/ 2>/dev/null || echo "No /mnt directory"
        echo ""
        
        echo "=== ä¸´æ—¶ç›®å½•å¤§å° ==="
        du -sh /tmp /var/tmp 2>/dev/null || true
        echo ""
        
        echo "=== Dockeræ ¹ç›®å½• ==="
        docker info 2>/dev/null | grep "Docker Root Dir" || echo "Docker not running"
        echo ""
        
        echo "=== æœ€å¤§çš„ç›®å½• ==="
        du -sh /* 2>/dev/null | sort -hr | head -10
        echo ""
        
        echo "=== /tmpç£ç›˜ç©ºé—´è¯¦æƒ… ==="
        df -h /tmp
        
    - name: Analyze remaining large components
      run: |
        echo "ğŸ” åˆ†æå‰©ä½™å¤§å‹ç»„ä»¶ï¼ˆç”¨äºä¼˜åŒ–æœªæ¥æ¸…ç†ï¼‰..."
        
        echo "=== å½“å‰æœ€å¤§çš„ç³»ç»Ÿç›®å½• ==="
        echo "åˆ†æ/usr/shareç›®å½•ï¼š"
        du -sh /usr/share/* 2>/dev/null | sort -hr | head -10
        echo ""
        
        echo "åˆ†æ/optç›®å½•ï¼š"
        du -sh /opt/* 2>/dev/null | sort -hr | head -10
        echo ""
        
        echo "åˆ†æ/usr/localç›®å½•ï¼š"
        du -sh /usr/local/* 2>/dev/null | sort -hr | head -10
        echo ""
        
        echo "=== æŸ¥æ‰¾100MB+çš„å¤§æ–‡ä»¶ ==="
        find /usr -type f -size +100M 2>/dev/null | head -10 || echo "No large files found"
        echo ""
        
        echo "=== è½»é‡çº§æ¸…ç†å‰©ä½™ç¼“å­˜ ==="
        sudo apt-get clean
        sudo apt-get autoremove -y --purge
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /tmp/* /var/tmp/* || true
        sudo journalctl --vacuum-time=1d || true
        
        echo "ğŸ³ æ¸…ç†Dockeræ—§ç¼“å­˜(ä¿ç•™6å°æ—¶å†…)..."
        docker system prune -f --filter "until=6h" || true
        docker builder prune -f --filter "until=6h" || true
        
        echo "=== æœ€ç»ˆæ¸…ç†æ•ˆæœæ€»ç»“ ==="
        echo "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
        if df -h /mnt >/dev/null 2>&1; then
          echo "/mntåˆ†åŒºå¯ç”¨ç©ºé—´: $(df -h /mnt | tail -1 | awk '{print $4}')"
        fi
        
        echo "ğŸ’¡ å»ºè®®ï¼šåŸºäºä»¥ä¸Šåˆ†æç»“æœï¼Œå¯ä»¥å°†æ–°å‘ç°çš„å¤§ç»„ä»¶æ·»åŠ åˆ°å¿«é€Ÿæ¸…ç†æ­¥éª¤ä¸­"
    
    - name: Checkout vLLM repository
      uses: actions/checkout@v4
      with:
        repository: vllm-project/vllm
        ref: ${{ inputs.vllm_version }}
        fetch-depth: 1
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          network=host
    
    - name: Log in to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
    
    - name: Prepare build environment
      run: |
        echo "ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ..."
        
        # è®¾ç½®æ„å»ºå˜é‡
        VLLM_VERSION="${{ inputs.vllm_version }}"
        CUDA_VERSION="${{ inputs.cuda_version }}"
        PYTHON_VERSION="${{ inputs.python_version }}"
        TORCH_CUDA_ARCH_LIST="${{ inputs.torch_cuda_arch_list }}"
        TARGET_NAMESPACE="${{ inputs.target_namespace }}"
        
        # æ¸…ç†ç‰ˆæœ¬å·ä¸­çš„æ–œæ å’Œå‰ç¼€ï¼Œç”Ÿæˆåˆæ³•çš„é•œåƒæ ‡ç­¾
        CLEAN_VERSION=$(echo "$VLLM_VERSION" | sed 's|releases/||g' | sed 's|/|_|g')
        IMAGE_TAG="${CLEAN_VERSION}_cu$(echo ${CUDA_VERSION} | tr -d '.')"
        TARGET_IMAGE="${{ env.ALIYUN_REGISTRY }}/${TARGET_NAMESPACE}/vllm:${IMAGE_TAG}"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "VLLM_VERSION=$VLLM_VERSION" >> $GITHUB_ENV
        echo "CLEAN_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
        echo "CUDA_VERSION=$CUDA_VERSION" >> $GITHUB_ENV
        echo "PYTHON_VERSION=$PYTHON_VERSION" >> $GITHUB_ENV
        echo "TORCH_CUDA_ARCH_LIST=$TORCH_CUDA_ARCH_LIST" >> $GITHUB_ENV
        echo "TARGET_IMAGE=$TARGET_IMAGE" >> $GITHUB_ENV
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "  vLLMç‰ˆæœ¬: $VLLM_VERSION"
        echo "  æ¸…ç†åç‰ˆæœ¬: $CLEAN_VERSION"
        echo "  CUDAç‰ˆæœ¬: $CUDA_VERSION"
        echo "  åŸºç¡€é•œåƒ: nvidia/cuda:${CUDA_VERSION}-devel-ubuntu22.04 (ç»Ÿä¸€ä½¿ç”¨22.04èŠ‚çœç©ºé—´)"
        echo "  Pythonç‰ˆæœ¬: $PYTHON_VERSION"
        echo "  CUDAæ¶æ„åˆ—è¡¨: $TORCH_CUDA_ARCH_LIST"
        echo "  ç›®æ ‡é•œåƒ: $TARGET_IMAGE"
    
    - name: Check disk space before build
      run: |
        echo "ğŸ“Š æ„å»ºå‰è¯¦ç»†ç£ç›˜ç©ºé—´åˆ†æ:"
        echo "=== æ€»ä½“ç£ç›˜ä½¿ç”¨ ==="
        df -h
        echo ""
        
        echo "=== /tmpç›®å½•è¯¦æƒ… ==="
        df -h /tmp
        du -sh /tmp/* 2>/dev/null | sort -hr | head -5 || echo "No files in /tmp"
        echo ""
        
        echo "=== Dockerç©ºé—´ä½¿ç”¨ ==="
        docker system df
        echo ""
        
        echo "=== å¤§æ–‡ä»¶ç›®å½•åˆ†æ ==="
        du -sh /usr/share/* 2>/dev/null | sort -hr | head -5
        echo ""
        
        echo "=== å¯ç”¨ç©ºé—´æ€»ç»“ ==="
        echo "æ ¹åˆ†åŒº: $(df -h / | tail -1 | awk '{print $4}') å¯ç”¨"
        echo "/tmpåˆ†åŒº: $(df -h /tmp | tail -1 | awk '{print $4}') å¯ç”¨"
    
    - name: Build vLLM Docker image
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»ºvLLM Dockeré•œåƒ..."
        
        
        # åŸºç¡€æ„å»ºå‚æ•°
        BUILD_ARGS=""
        BUILD_ARGS="$BUILD_ARGS --build-arg CUDA_VERSION=$CUDA_VERSION"
        BUILD_ARGS="$BUILD_ARGS --build-arg PYTHON_VERSION=$PYTHON_VERSION"
        BUILD_ARGS="$BUILD_ARGS --build-arg torch_cuda_arch_list=\"$TORCH_CUDA_ARCH_LIST\""
        BUILD_ARGS="$BUILD_ARGS --build-arg BUILD_BASE_IMAGE=nvidia/cuda:${CUDA_VERSION}-devel-ubuntu22.04"
        BUILD_ARGS="$BUILD_ARGS --build-arg FINAL_BASE_IMAGE=nvidia/cuda:${CUDA_VERSION}-devel-ubuntu22.04"
        
        echo "ğŸ” æ„å»ºå‚æ•°è¯¦ç»†æ£€æŸ¥:"
        echo "BUILD_ARGS: $BUILD_ARGS"
        echo "TARGET_IMAGE: $TARGET_IMAGE"
        echo "PWD: $(pwd)"
        echo "DOCKER_TMPDIR: $DOCKER_TMPDIR"
        echo "TMPDIR: $TMPDIR"
        echo ""
        
        echo "éªŒè¯åŸºç¡€é•œåƒå‚æ•°:"
        echo "BUILD_BASE_IMAGE: nvidia/cuda:${CUDA_VERSION}-devel-ubuntu20.04"
        echo "FINAL_BASE_IMAGE: nvidia/cuda:${CUDA_VERSION}-devel-ubuntu22.04"
        echo ""
        
        echo "å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        echo ""
        
        echo "Dockerfileå­˜åœ¨æ£€æŸ¥:"
        ls -la docker/Dockerfile 2>/dev/null || echo "âŒ Dockerfile not found!"
        if [ -f docker/Dockerfile ]; then
          echo "âœ… Dockerfile found"
          echo "Dockerfileå‰10è¡Œ:"
          head -10 docker/Dockerfile
        fi
        echo ""
        
        echo "Docker buildxç‰ˆæœ¬:"
        docker buildx version
        echo ""
        
        # æ‰§è¡Œæ„å»º
        echo "ğŸ”¨ æ‰§è¡ŒDockeræ„å»º..."
        
        # æ„å»ºå‰å†æ¬¡æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "æ„å»ºå¼€å§‹å‰ç£ç›˜çŠ¶æ€:"
        df -h / /tmp
        docker system df
        
        # ä½¿ç”¨buildxæ„å»ºï¼Œç¡®ä¿åœ¨vLLMä»“åº“ç›®å½•ä¸­æ‰§è¡Œ
        echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ç¡®è®¤åœ¨vLLMä»“åº“ä¸­æ„å»º..."
        
        docker buildx build \
            $BUILD_ARGS \
            --target vllm-openai \
            --tag "$TARGET_IMAGE" \
            --file docker/Dockerfile \
            --load \
            .
        
        echo "âœ… æ„å»ºå®Œæˆ!"
        echo "é•œåƒ: $TARGET_IMAGE"
    
    - name: Check disk space after build
      run: |
        echo "ğŸ“Š æ„å»ºåè¯¦ç»†ç£ç›˜ç©ºé—´åˆ†æ:"
        echo "=== æ€»ä½“ç£ç›˜ä½¿ç”¨å˜åŒ– ==="
        df -h / /mnt /tmp
        echo ""
        
        echo "=== Dockerç©ºé—´ä½¿ç”¨è¯¦æƒ… ==="
        docker system df
        echo ""
        
        echo "=== å¤§å‹ç›®å½•å½“å‰çŠ¶æ€ ==="
        du -sh /var/lib/docker /mnt /tmp 2>/dev/null || true
        echo ""
        
        echo "=== æ„å»ºäº§ç”Ÿçš„æ–‡ä»¶ ==="
        find /mnt -name "*docker*" -type d 2>/dev/null | head -5 || true
        echo ""
        
        # æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡å¹¶ç»™å‡ºå»ºè®®
        ROOT_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
        MNT_USAGE=$(df /mnt | tail -1 | awk '{print $5}' | sed 's/%//')
        
        echo "=== ç£ç›˜ä½¿ç”¨ç‡åˆ†æ ==="
        echo "æ ¹åˆ†åŒºä½¿ç”¨ç‡: ${ROOT_USAGE}%"
        echo "/mntåˆ†åŒºä½¿ç”¨ç‡: ${MNT_USAGE}%"
        
        if [ "$ROOT_USAGE" -gt 85 ]; then
          echo "âš ï¸ æ ¹åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
          docker system prune -f
          docker image prune -af --filter "until=1h"
        fi
        DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
        if [ "$DISK_USAGE" -gt 85 ]; then
          echo "âš ï¸ ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡85%ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
          docker system prune -f
          docker image prune -af --filter "until=1h"
        fi
    
    - name: Test built image
      run: |
        echo "ğŸ§ª æµ‹è¯•æ„å»ºçš„é•œåƒ..."
        
        # ç®€å•çš„é•œåƒæµ‹è¯•
        echo "æ£€æŸ¥é•œåƒæ˜¯å¦å¯ä»¥æ­£å¸¸å¯åŠ¨..."
        docker run --rm "$TARGET_IMAGE" python -c "import vllm; print(f'vLLM version: {vllm.__version__}')" || {
          echo "âŒ é•œåƒæµ‹è¯•å¤±è´¥"
          exit 1
        }
        
        echo "âœ… é•œåƒæµ‹è¯•é€šè¿‡"
    
    - name: Push to Aliyun Registry
      run: |
        echo "ğŸ“¤ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘..."
        
        docker push "$TARGET_IMAGE"
        
        echo "âœ… æ¨é€å®Œæˆ!"
        echo "é•œåƒåœ°å€: $TARGET_IMAGE"
    
    - name: Clean up and final report
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
        
        # åˆ é™¤æœ¬åœ°é•œåƒé‡Šæ”¾ç©ºé—´
        docker rmi "$TARGET_IMAGE" || true
        
        # æ¸…ç†æ„å»ºç¼“å­˜
        docker system prune -f
        docker builder prune -f
        
        echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š:"
        echo "=================="
        echo "æ„å»ºä¿¡æ¯:"
        echo "  vLLMç‰ˆæœ¬: $VLLM_VERSION"
        echo "  CUDAç‰ˆæœ¬: $CUDA_VERSION"
        echo "  Pythonç‰ˆæœ¬: $PYTHON_VERSION"
        echo "  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
        echo ""
        echo "é•œåƒåœ°å€:"
        echo "  $TARGET_IMAGE"
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•:"
        echo "  docker pull $TARGET_IMAGE"
        echo ""
        echo "ç£ç›˜ç©ºé—´:"
        df -h /
        echo ""
        echo "æ„å»ºå®Œæˆæ—¶é—´: $(date)"