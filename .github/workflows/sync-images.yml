name: Sync Images to Aliyun Registry

on:
  workflow_dispatch:
    inputs:
      source_image:
        description: '源镜像 (例如: nvidia/cuda:12.1.1-devel-ubuntu22.04)'
        required: true
        type: string
      target_tag:
        description: '目标标签 (例如: 12.1.1-devel-ubuntu22.04，留空则使用源镜像标签)'
        required: false
        type: string
      target_namespace:
        description: '目标命名空间'
        required: false
        default: 'yoce/cuda'
        type: string

env:
  ALIYUN_REGISTRY: registry.cn-beijing.aliyuncs.com

jobs:
  sync-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Free up disk space
      run: |
        echo "🧹 深度清理系统空间..."
        
        # 清理APT缓存和系统垃圾
        sudo apt-get clean
        sudo apt-get autoremove -y --purge
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        # 清理系统日志
        sudo journalctl --vacuum-size=50M
        
        # 清理Docker系统（包括构建缓存）
        docker system prune -af --volumes || true
        docker builder prune -af --filter "until=1h" || true
        
        # 清理不必要的系统文件
        sudo find /var/log -type f -name "*.log" -size +50M -delete || true
        sudo find /var/cache -type f -delete || true
        
        echo "深度清理后磁盘空间:"
        df -h /
        echo ""
        echo "可用内存:"
        free -h
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Aliyun Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
    
    - name: Parse image information
      run: |
        SOURCE_IMAGE="${{ inputs.source_image }}"
        TARGET_NAMESPACE="${{ inputs.target_namespace || 'yoce/cuda' }}"
        TARGET_TAG="${{ inputs.target_tag }}"
        
        # 如果没有指定目标标签，从源镜像提取
        if [[ -z "$TARGET_TAG" ]]; then
          if [[ "$SOURCE_IMAGE" == *":"* ]]; then
            TARGET_TAG="${SOURCE_IMAGE##*:}"
          else
            TARGET_TAG="latest"
          fi
        fi
        
        TARGET_IMAGE="${{ env.ALIYUN_REGISTRY }}/${TARGET_NAMESPACE}:${TARGET_TAG}"
        
        # 设置环境变量
        echo "SOURCE_IMAGE=$SOURCE_IMAGE" >> $GITHUB_ENV
        echo "TARGET_IMAGE=$TARGET_IMAGE" >> $GITHUB_ENV
        echo "TARGET_TAG=$TARGET_TAG" >> $GITHUB_ENV
        
        echo "🔄 同步镜像:"
        echo "  源镜像: $SOURCE_IMAGE"
        echo "  目标镜像: $TARGET_IMAGE"
    
    - name: Check disk space before pull
      run: |
        echo "📊 拉取前磁盘空间:"
        df -h /
        echo ""
        echo "Docker空间使用:"
        docker system df
    
    - name: Sync image to Aliyun Registry
      run: |
        echo "📥 拉取源镜像..."
        # 设置Docker的并发拉取
        export DOCKER_BUILDKIT=1
        docker pull "$SOURCE_IMAGE"
        
        echo "📊 拉取后磁盘空间:"
        df -h /
        
        # 检查是否需要清理空间
        DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
        if [ "$DISK_USAGE" -gt 80 ]; then
          echo "⚠️ 磁盘使用率超过80%，执行紧急清理..."
          docker system prune -f
          sudo rm -rf /tmp/* /var/tmp/* || true
        fi
        
        echo "🏷️ 标记镜像..."
        docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
        
        echo "📤 推送到阿里云镜像仓库..."
        docker push "$TARGET_IMAGE"
        
        echo "✅ 同步完成!"
        echo "镜像地址: $TARGET_IMAGE"
    
    - name: Clean up and verify
      run: |
        echo "🧹 清理本地镜像..."
        # 删除本地镜像以释放空间
        docker rmi "$SOURCE_IMAGE" || true
        docker rmi "$TARGET_IMAGE" || true
        
        # 清理未使用的镜像和容器
        docker system prune -f
        
        # 额外的空间清理
        docker volume prune -f || true
        docker network prune -f || true
        
        echo "🔍 验证镜像可用性..."
        # 使用manifest inspect验证镜像存在，避免重新下载
        if docker manifest inspect "$TARGET_IMAGE" > /dev/null 2>&1; then
          echo "✅ 镜像同步成功，可以正常拉取"
          echo "镜像信息验证通过"
        else
          echo "❌ 镜像验证失败"
          exit 1
        fi
        
        echo "📊 最终状态报告:"
        echo "================="
        echo "磁盘空间:"
        df -h /
        echo ""
        echo "Docker空间使用:"
        docker system df
        echo ""
        echo "内存使用:"
        free -h
        echo ""
        echo "同步完成时间: $(date)"